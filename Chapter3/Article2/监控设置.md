## 在Elasticsearch监控设置

默认情况下，启用监视，但禁用数据收集。要启用数据收集，请使用该`xpack.monitoring.collection.enabled`设置。

您可以在`elasticsearch.yml`文件中配置这些监视设置。您还可以使用[群集更新设置API](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/cluster-update-settings.html)动态设置其中一些 [设置](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/cluster-update-settings.html)。

> 群集设置优先于`elasticsearch.yml` 文件中的设置。

要调整如何监控数据显示在监控界面，配置 [`xpack.monitoring`设置](https://www.elastic.co/guide/en/kibana/7.x/monitoring-settings-kb.html)中 `kibana.yml`。要控制如何从Logstash收集监视数据，请在中配置监视设置`logstash.yml`。

有关更多信息，请参阅[监视集群](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/monitor-elasticsearch-cluster.html)。

#### 常规监视设置

- **`xpack.monitoring.enabled`**

    设置为`true`（默认值）以对节点上的Elasticsearch启用Elasticsearch X-Pack监视。

    > 要启用数据收集，还必须将设置`xpack.monitoring.collection.enabled` 为`true`。默认值为`false`。

#### 监视收集设置

这些`xpack.monitoring.collection`设置控制如何从Elasticsearch节点收集数据。您可以使用[群集更新设置API](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/cluster-update-settings.html)动态更改所有监视收集设置。

- **`xpack.monitoring.collection.enabled`（[Dynamic](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/cluster-update-settings.html)）**

    在6.3.0中添加。设置为`true`启用监视数据收集。当此设置为`false`默认值时，将不会收集Elasticsearch监视数据，并且会忽略来自其他来源（如Kibana，Beats和Logstash）的所有监视数据。

- **`xpack.monitoring.collection.interval`（[Dynamic](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/cluster-update-settings.html)）**

    设置为`-1`禁用数据收集,从7.0.0开始不再支持 。 在6.3.0中弃用。使用`xpack.monitoring.collection.enabled`设置为`false`来替代。控制收集数据样本的频率。默认为`10s`。如果您修改收集间隔，则将`xpack.monitoring.min_interval_seconds` 选项设置`kibana.yml`为相同的值。

- **`xpack.monitoring.elasticsearch.collection.enabled`（[动态](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/cluster-update-settings.html)）**

    控制是否应收集有关Elasticsearch集群的统计信息。默认为`true`。这与xpack.monitoring.collection.enabled不同，后者允许您启用或禁用所有监视收集。但是，此设置只是禁用了Elasticsearch数据的收集，同时仍然允许其他数据（例如，Kibana，Logstash，Beats或APM Server监视数据）通过此群集。

- **`xpack.monitoring.collection.cluster.stats.timeout`（[动态](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/cluster-update-settings.html)）**

    （[时间值](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/common-options.html#time-units)）用于收集集群统计信息的超时。默认为`10s`。

- **`xpack.monitoring.collection.node.stats.timeout`（[动态](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/cluster-update-settings.html)）**

    （[时间值](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/common-options.html#time-units)）收集节点统计信息的超时[时间](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/common-options.html#time-units)。默认为`10s`。

- **`xpack.monitoring.collection.indices`（[动态](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/cluster-update-settings.html)）**

    控制监控从哪个索引收集数据。默认为所有索引。将索引名称指定为以逗号分隔的列表，例如`test1,test2,test3`。名称可以包括通配符，例如`test*`。您可以在前缀前明确排除索引`-`。例如，`test*,-test3`将监视`test`除以外的所有所有索引`test3`。系统索引（如.security *或.kibana *）始终以开头`.`，通常应对其进行监视。考虑添加`.*`到索引列表中，以确保监视系统索引。例如`.*,test*,-test3`

- **`xpack.monitoring.collection.index.stats.timeout`（[动态](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/cluster-update-settings.html)）**

    （[时间值](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/common-options.html#time-units)）用于收集索引统计信息的超时。默认为`10s`。

- **`xpack.monitoring.collection.index.recovery.active_only`（[动态](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/cluster-update-settings.html)）**

    控制是否收集所有回收率。设置为`true`仅收集活动的恢复。默认为`false`。

- **`xpack.monitoring.collection.index.recovery.timeout`（[动态](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/cluster-update-settings.html)）**

    （[时间值](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/common-options.html#time-units)）用于收集恢复信息的超时。默认为`10s`。

- **`xpack.monitoring.history.duration`（[动态](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/cluster-update-settings.html)）**

    （[时间值](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/common-options.html#time-units)）保留期限，超过该期限后，将自动删除监视导出器创建的索引。默认为`7d`（7天）。此设置的最小值`1d`（1天）以确保正在监视某些内容，并且不能将其禁用。

    > 此设置当前仅影响`local`类型出口商。使用`http`导出器创建的索引不会自动删除。

- **`xpack.monitoring.exporters`**

    配置代理在何处存储监视数据。默认情况下，代理使用本地导出程序，该导出程序对安装了群集的监视数据进行索引。使用HTTP导出器将数据发送到单独的监视群集。有关更多信息，请参阅[本地导出器设置](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/monitoring-settings.html#local-exporter-settings)， [HTTP导出器设置](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/monitoring-settings.html#http-exporter-settings)及其 [*工作方式*](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/how-monitoring-works.html)。

#### 本地出口商设置

该`local`出口是通过监测使用的默认出口国。顾名思义，它会将数据导出到*本地*群集，这意味着不需要太多配置。

如果您不提供*任何*出口商，Monitoring会自动为您创建一个。如果提供了任何导出器，则不添加默认值。

```yaml
xpack.monitoring.exporters.my_local:
  type: local
```

- **`type`**

    本地出口商的值必须始终为`local`并且是必需的。

- **`use_ingest`**

    是否在每个批量请求中向集群和管道处理器提供占位符管道。默认值为`true`。如果被禁用，则意味着它将不使用管道，这意味着将来的发行版无法将批量请求自动升级为可用于将来的请求。

- **`cluster_alerts.management.enabled`**

    是否为此集群创建集群警报。默认值为`true`。要使用此功能，必须启用Watcher。如果您具有基本许可证，则不会显示群集警报。

#### HTTP导出器设置

以下列出了`http`导出器可以提供的设置。所有设置均显示在您为导出器选择的名称后面：

```yaml
xpack.monitoring.exporters.my_remote:
  type: http
  host: ["host:port", ...]
```

- **`type`**

    HTTP导出程序的值必须始终为`http`并且是必需的。

- **`host`**

    主机支持多种格式，既可以是数组，也可以是单个值。支持的格式包括 `hostname`，`hostname:port`，`http://hostname`, `http://hostname:port`，`https://hostname`，和 `https://hostname:port`。不能假定主机。如果未作为字符串的一部分提供，则默认方案始终为`http`，默认端口始终`9200`为`host`。

    ```properties
    xpack.monitoring.exporters:
      example1:
        type: http
        host: "10.1.2.3"
      example2:
        type: http
        host: ["http://10.1.2.4"]
      example3:
        type: http
        host: ["10.1.2.5", "10.1.2.6"]
      example4:
        type: http
        host: ["https://10.1.2.3:9200"]
    ```

    

- **`auth.username`**

    如果提供`auth.secure_password`或，`auth.password`则用户名是必需的。

- **`auth.secure_password`（[安全](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/secure-settings.html)，[可重新加载](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/secure-settings.html#reloadable-secure-settings)）**

    的密码`auth.username`。`auth.password`如果也指定了优先级。

- **`auth.password`**

    的密码`auth.username`。如果`auth.secure_password`还指定，则将忽略此设置。

### 在7.7.0中弃用。

使用`auth.secure_password`代替。

- **`connection.timeout`**

    （[时间值](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/common-options.html#time-units)）HTTP连接应该等待套接字打开以请求的时间。默认值为`6s`。

- **`connection.read_timeout`**

    （[时间值](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/common-options.html#time-units)）HTTP连接应该等待套接字发送回响应的时间。默认值为`10 * connection.timeout`（`60s`如果未设置）。

- **`ssl`**

    每个HTTP导出器都可以定义自己的TLS / SSL设置或继承它们。请参阅[下面](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/monitoring-settings.html#ssl-monitoring-settings)的“ [TLS / SSL”部分](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/monitoring-settings.html#ssl-monitoring-settings)。

- **`proxy.base_path`**

    前缀任何传出请求的基本路径，例如`/base/path`（然后，批量请求将作为发送`/base/path/_bulk`）。没有默认值。

- **`headers`**

    添加到每个请求的可选标头，可以帮助通过代理路由请求。

    ```properties
    xpack.monitoring.exporters.my_remote:
      headers:
        X-My-Array: [abc, def, xyz]
        X-My-Header: abc123
    ```

    发送基于数组的标头的`n`时间`n`为数组的大小。`Content-Type` 并且`Content-Length`无法设置。监视代理程序创建的任何标题都将覆盖此处定义的任何内容。

- **`index.name.time_format`**

    一种用于更改默认情况下每日监控索引的默认日期后缀的机制。默认值为`YYYY.MM.DD`，这就是为什么每天创建索引的原因。

- **`use_ingest`**

    是否在每个批量请求时向监视集群和管道处理器提供占位符管道。默认值为`true`。如果被禁用，则意味着它将不使用管道，这意味着将来的发行版无法将批量请求自动升级为可用于将来的请求。

- **`cluster_alerts.management.enabled`**

    是否为此集群创建集群警报。默认值为`true`。要使用此功能，必须启用Watcher。如果您具有基本许可证，则不会显示群集警报。

- **`cluster_alerts.management.blacklist`**

    阻止创建特定的群集警报。它还会删除当前群集中已经存在的所有适用监视。 您可以将以下任意手表标识符添加到黑名单中：

    - `elasticsearch_cluster_status`
    - `elasticsearch_version_mismatch`
    - `elasticsearch_nodes`
    - `kibana_version_mismatch`
    - `logstash_version_mismatch`
    - `xpack_license_expiration`

    例如：`["elasticsearch_version_mismatch","xpack_license_expiration"]`。

### X-Pack监视TLS / SSL设置

您可以配置以下TLS / SSL设置。

- **`xpack.monitoring.exporters.$NAME.ssl.supported_protocols`**

    支持的协议版本。有效协议：`SSLv2Hello`， `SSLv3`，`TLSv1`，`TLSv1.1`，`TLSv1.2`，`TLSv1.3`。如果JVM的SSL提供程序支持TLSv1.3，则默认值为`TLSv1.3,TLSv1.2,TLSv1.1`。否则，默认值为 `TLSv1.2,TLSv1.1`。如果`xpack.security.fips_mode.enabled`是`true`，则不能使用`SSLv2Hello` 或`SSLv3`。请参阅[FIPS 140-2](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/fips-140-compliance.html)。

- **`xpack.monitoring.exporters.$NAME.ssl.verification_mode`**

    控制证书的验证。有效值为：`full`，它验证所提供的证书是否由受信任的机构（CA）签名，还验证服务器的主机名（或IP地址）是否与证书中标识的名称匹配。`certificate`，它验证提供的证书是否由受信任的权威（CA）签名，但不执行任何主机名验证。`none`，*不对*服务器证书进行*任何验证*。此模式禁用了SSL / TLS的许多安全性优点，只有在仔细考虑后才能使用。它主要是在尝试解决TLS错误时作为一种临时诊断机制。强烈建议不要将其用于生产集群。默认值为`full`。

- **`xpack.monitoring.exporters.$NAME.ssl.cipher_suites`**

    支持的密码套件取决于您使用的Java版本。例如，对于11版的默认值是`TLS_AES_256_GCM_SHA384`， `TLS_AES_128_GCM_SHA256`，`TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384`， `TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256`，`TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384`， `TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256`，`TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384`， `TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256`，`TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384`， `TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256`，`TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA`， `TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA`，`TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA`， `TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA`，`TLS_RSA_WITH_AES_256_GCM_SHA384`， `TLS_RSA_WITH_AES_128_GCM_SHA256`，`TLS_RSA_WITH_AES_256_CBC_SHA256`， `TLS_RSA_WITH_AES_128_CBC_SHA256`，`TLS_RSA_WITH_AES_256_CBC_SHA`， `TLS_RSA_WITH_AES_128_CBC_SHA`。上面的默认密码套件列表包括TLSv1.3密码，以及需要256位AES加密的*Java密码学扩展（JCE）无限强度管辖权策略文件*的密码。如果TLSv1.3是不可用，TLSv1.3密码`TLS_AES_256_GCM_SHA384`和 `TLS_AES_128_GCM_SHA256`不包括在默认列表。如果256位AES不可用，则`AES_256`其名称中带有密码的密码将不包括在默认列表中。最后，AES GCM在11之前的Java版本中存在性能问题，并且仅在使用Java 11或更高版本时才包含在默认列表中。有关更多信息，请参见Oracle的 [Java密码体系结构文档](https://docs.oracle.com/en/java/javase/11/security/oracle-providers.html#GUID-7093246A-31A3-4304-AC5F-5FB6400405E2)。

#### X-Pack监视TLS / SSL密钥和受信任的证书设置

以下设置用于指定通过SSL / TLS连接进行通信时应使用的私钥，证书和受信任证书。私钥和证书是可选的，如果服务器要求客户端认证进行PKI认证，则将使用私钥和证书。

#### PEM编码的文件

使用PEM编码的文件时，请使用以下设置：

- **`xpack.monitoring.exporters.$NAME.ssl.key`**

    包含私钥的PEM编码文件的路径。

- **`xpack.monitoring.exporters.$NAME.ssl.key_passphrase`**

    用于解密私钥的密码。由于密钥可能未加密，因此此值是可选的。

- **`xpack.monitoring.exporters.$NAME.ssl.secure_key_passphrase`（[安全](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/secure-settings.html)）**

    用于解密私钥的密码。由于密钥可能未加密，因此此值是可选的。

- **`xpack.monitoring.exporters.$NAME.ssl.certificate`**

    指定与密钥关联的PEM编码证书（或证书链）的路径。

- **`xpack.monitoring.exporters.$NAME.ssl.certificate_authorities`**

    应当信任的PEM编码证书文件的路径列表。

#### Java密钥库文件

使用包含私钥，证书和应受信任的证书的Java密钥库文件（JKS）时，请使用以下设置：

- **`xpack.monitoring.exporters.$NAME.ssl.keystore.path`**

    包含私钥和证书的密钥库文件的路径。

- **`xpack.monitoring.exporters.$NAME.ssl.keystore.password`**

    密钥库的密码。

- **`xpack.monitoring.exporters.$NAME.ssl.keystore.secure_password`（[安全](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/secure-settings.html)）**

    密钥库的密码。

- **`xpack.monitoring.exporters.$NAME.ssl.keystore.key_password`**

    密钥库中密钥的密码。缺省值为密钥库密码。

- **`xpack.monitoring.exporters.$NAME.ssl.keystore.secure_key_password`（[安全](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/secure-settings.html)）**

    密钥库中密钥的密码。缺省值为密钥库密码。

- **`xpack.monitoring.exporters.$NAME.ssl.truststore.path`**

    包含要信任的证书的密钥库的路径。它必须是Java密钥库（jks）或PKCS＃12文件。

- **`xpack.monitoring.exporters.$NAME.ssl.truststore.password`**

    信任库的密码。

- **`xpack.monitoring.exporters.$NAME.ssl.truststore.secure_password`（[安全](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/secure-settings.html)）**

    信任库的密码。

#### PKCS＃12文件

可以将Elasticsearch配置为使用包含私有密钥，证书和应受信任的证书的PKCS＃12容器文件（`.p12`或多个`.pfx`文件）。

PKCS＃12文件的配置方式与Java密钥库文件相同：

- **`xpack.monitoring.exporters.$NAME.ssl.keystore.path`**

    包含私钥和证书的密钥库文件的路径。

- **`xpack.monitoring.exporters.$NAME.ssl.keystore.type`**

    密钥库文件的格式。它必须是`jks`或`PKCS12`。如果密钥库路径以“ .p12”，“。pfx”或“ .pkcs12”结尾，则此设置默认为`PKCS12`。否则，默认为`jks`。

- **`xpack.monitoring.exporters.$NAME.ssl.keystore.password`**

    密钥库的密码。

- **`xpack.monitoring.exporters.$NAME.ssl.keystore.secure_password`（[安全](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/secure-settings.html)）**

    密钥库的密码。

- **`xpack.monitoring.exporters.$NAME.ssl.keystore.key_password`**

    密钥库中密钥的密码。缺省值为密钥库密码。

- **`xpack.monitoring.exporters.$NAME.ssl.keystore.secure_key_password`（[安全](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/secure-settings.html)）**

    密钥库中密钥的密码。缺省值为密钥库密码。

- **`xpack.monitoring.exporters.$NAME.ssl.truststore.path`**

    包含要信任的证书的密钥库的路径。它必须是Java密钥库（jks）或PKCS＃12文件。

- **`xpack.monitoring.exporters.$NAME.ssl.truststore.type`**

    进行设置`PKCS12`以指示信任库是PKCS＃12文件。

- **`xpack.monitoring.exporters.$NAME.ssl.truststore.password`**

    信任库的密码。

- **`xpack.monitoring.exporters.$NAME.ssl.truststore.secure_password`（[安全](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/secure-settings.html)）**

    信任库的密码。

#### PKCS＃11令牌

可以将Elasticsearch配置为使用PKCS＃11令牌，该令牌包含私钥，证书和应信任的证书。

PKCS＃11令牌需要在JVM级别进行其他配置，并且可以通过以下设置启用：

- **`xpack.monitoring.exporters.$NAME.keystore.type`**

    进行设置`PKCS11`以指示应将PKCS＃11令牌用作密钥库。

- **`xpack.monitoring.exporters.$NAME.truststore.type`**

    信任库文件的格式。对于Java密钥库格式，请使用`jks`。对于PKCS＃12文件，使用`PKCS12`。对于PKCS＃11令牌，请使用`PKCS11`。默认值为 `jks`。

在配置将JVM配置为用作Elasticsearch的密钥库或信任库的PKCS＃11令牌时，可以通过将适当的值设置为`ssl.truststore.password` 或`ssl.truststore.secure_password`在您配置的上下文中配置令牌的PIN 。由于只能配置一个PKCS＃11令牌，因此只有一个密钥库和信任库可用于在Elasticsearch中进行配置。反过来，这意味着在传输层和http层中，只能将一个证书用于TLS。