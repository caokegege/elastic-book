## 日志配置

Elasticsearch使用[Log4j 2](https://logging.apache.org/log4j/2.x/)进行日志记录。可以使用log4j2.properties文件配置Log4j 2。Elasticsearch公开三个属性`${sys:es.logs.base_path}`， `${sys:es.logs.cluster_name}`以及`${sys:es.logs.node_name}`可以在配置文件中引用，以确定日志文件的位置。该属性`${sys:es.logs.base_path}`将解析为日志目录， `${sys:es.logs.cluster_name}`并将解析为群集名称（在默认配置中用作日志文件名的前缀）， `${sys:es.logs.node_name}`并将解析为节点名称（如果显式设置了节点名称）。

例如，如果你的日志目录（`path.logs`）是`/var/log/elasticsearch`和您的群集名为`production`然后`${sys:es.logs.base_path}`将解析`/var/log/elasticsearch`和 `${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs.cluster_name}.log` 将解析`/var/log/elasticsearch/production.log`。

```properties
######## Server JSON ############################
appender.rolling.type = RollingFile 
appender.rolling.name = rolling
appender.rolling.fileName = ${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs.cluster_name}_server.json 
appender.rolling.layout.type = ESJsonLayout 
appender.rolling.layout.type_name = server 
appender.rolling.filePattern = ${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs.cluster_name}-%d{yyyy-MM-dd}-%i.json.gz 
appender.rolling.policies.type = Policies
appender.rolling.policies.time.type = TimeBasedTriggeringPolicy 
appender.rolling.policies.time.interval = 1 
appender.rolling.policies.time.modulate = true 
appender.rolling.policies.size.type = SizeBasedTriggeringPolicy 
appender.rolling.policies.size.size = 256MB 
appender.rolling.strategy.type = DefaultRolloverStrategy
appender.rolling.strategy.fileIndex = nomax
appender.rolling.strategy.action.type = Delete 
appender.rolling.strategy.action.basepath = ${sys:es.logs.base_path}
appender.rolling.strategy.action.condition.type = IfFileName 
appender.rolling.strategy.action.condition.glob = ${sys:es.logs.cluster_name}-* 
appender.rolling.strategy.action.condition.nested_condition.type = IfAccumulatedFileSize 
appender.rolling.strategy.action.condition.nested_condition.exceeds = 2GB 
################################################
```

可以查看[释义](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/logging.html)

```properties
######## Server -  old style pattern ###########
appender.rolling_old.type = RollingFile
appender.rolling_old.name = rolling_old
appender.rolling_old.fileName = ${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs.cluster_name}_server.log 
appender.rolling_old.layout.type = PatternLayout
appender.rolling_old.layout.pattern = [%d{ISO8601}][%-5p][%-25c{1.}] [%node_name]%marker %m%n
appender.rolling_old.filePattern = ${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs.cluster_name}-%d{yyyy-MM-dd}-%i.old_log.gz
```

`old style`模式追加器的配置。这些日志将保存在`*.log`文件中，如果存档则将保存在文件中`* .log.gz`。请注意，应将其视为已弃用，并将在将来删除。

> Log4j的配置解析被任何多余的空白所迷惑；如果您在此页面上复制并粘贴任何Log4j设置，或通常输入任何Log4j配置，请确保修剪所有前导和尾随空格。

请注意，您可以替换`.gz`为`.zip`in `appender.rolling.filePattern`以使用zip格式压缩滚动日志。如果删除`.gz` 扩展名，则日志在滚动时将不会被压缩。

如果要在指定时间段内保留日志文件，则可以将过渡策略与删除操作一起使用。

```properties
appender.rolling.strategy.type = DefaultRolloverStrategy 
appender.rolling.strategy.action.type = Delete 
appender.rolling.strategy.action.basepath = ${sys:es.logs.base_path} 
appender.rolling.strategy.action.condition.type = IfFileName 
appender.rolling.strategy.action.condition.glob = ${sys:es.logs.cluster_name}-* 
appender.rolling.strategy.action.condition.nested_condition.type = IfLastModified 
appender.rolling.strategy.action.condition.nested_condition.age = 7D 
```

点击查看[释义](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/logging.html)

可以加载多个配置文件（在这种情况下，它们将被合并），只要它们被命名`log4j2.properties`并将Elasticsearch config目录作为祖先即可。这对于公开其他记录器的插件很有用。记录器部分包含Java软件包及其相应的日志级别。附加程序部分包含日志的目标。在[Log4j文档中](http://logging.apache.org/log4j/2.x/manual/configuration.html)可以找到有关如何自定义日志记录和所有受支持的附加程序的广泛信息 。

### 配置日志记录级别

有四种配置日志记录级别的方法，每种方法都有适合使用的情况。

1. 通过命令行：`-E <name of logging hierarchy>=<level>`(例如， `-E logger.org.elasticsearch.transport=trace`）。当您临时调试单个节点上的问题（例如，启动问题或开发过程中）时，这是最合适的。

2. 通过`elasticsearch.yml`：（ 例如， `logger.org.elasticsearch.transport: trace`）。当您临时调试问题但未通过命令行（例如，通过服务）启动Elasticsearch或希望更永久地调整日志记录级别时，这是最合适的。

3. 通过[集群设置](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/misc-cluster.html#cluster-logger)：

    ```js
    PUT /_cluster/settings
    {
      "transient": {
        "<name of logging hierarchy>": "<level>"
      }
    }
    ```

    例如：

    ```console
    PUT /_cluster/settings
    {
      "transient": {
        "logger.org.elasticsearch.transport": "trace"
      }
    } 
    ```

    当您需要动态地调整正在运行的群集上的日志记录级别时，这是最合适的。

4. 通过`log4j2.properties`：

    ```properties
    logger.<unique_identifier>.name = <name of logging hierarchy>
    logger.<unique_identifier>.level = <level>
    ```

    例如：

    ```properties
    logger.transport.name = org.elasticsearch.transport
    logger.transport.level = trace
    ```

    当您需要对记录器进行细粒度控制时（例如，要将记录器发送到另一个文件或以其他方式管理记录器；这是一种罕见的用例），这是最合适的。

### 过时的日志

除了常规日志记录外，Elasticsearch还允许您启用不赞成使用的操作的日志记录。例如，这使您可以及早确定是否将来需要迁移某些功能。默认情况下，在WARN级别启用弃用日志记录，该级别将发出所有弃用日志消息。

```properties
logger.deprecation.level = warn
```

这将在您的日志目录中创建每日滚动弃用日志文件。定期检查此文件，尤其是在您打算升级到新的主要版本时。

默认的日志记录配置已将弃用日志的滚动策略设置为在1 GB之后滚动和压缩，并最多保留五个日志文件（四个滚动日志和活动日志）。

您可以`config/log4j2.properties`通过将弃用日志级别设置为以下方式在文件中禁用它`error`：

```properties
logger.deprecation.name = org.elasticsearch.deprecation
logger.deprecation.level = error
```

如果`X-Opaque-Id`用作HTTP标头，则可以确定触发过时功能的原因。用户ID包含`X-Opaque-ID`在弃用JSON日志的字段中。

```js
{
  "type": "deprecation",
  "timestamp": "2019-08-30T12:07:07,126+02:00",
  "level": "WARN",
  "component": "o.e.d.r.a.a.i.RestCreateIndexAction",
  "cluster.name": "distribution_run",
  "node.name": "node-0",
  "message": "[types removal] Using include_type_name in create index requests is deprecated. The parameter will be removed in the next major version.",
  "x-opaque-id": "MY_USER_ID",
  "cluster.uuid": "Aq-c-PAeQiK3tfBYtig9Bw",
  "node.id": "D7fUYfnfTLa2D7y-xw6tZg"
}  
```

### JSON日志格式

为了简化对Elasticsearch日志的解析，现在以JSON格式打印日志。这由Log4J布局属性配置`appender.rolling.layout.type = ESJsonLayout`。此布局需要`type_name`设置一个属性，该属性用于在解析时区分日志流。

```properties
appender.rolling.layout.type = ESJsonLayout
appender.rolling.layout.type_name = server
```

每行包含一个JSON文档，其属性在中配置`ESJsonLayout`。有关更多详细信息，请参见此类[javadoc](https://snapshots.elastic.co/javadoc/org/elasticsearch/elasticsearch/7.8.0-SNAPSHOT/org/elasticsearch/common/logging/ESJsonLayout.html)。但是，如果JSON文档包含异常，它将被打印在多行上。第一行将包含常规属性，随后的行将包含格式为JSON数组的stacktrace。

> 您仍然可以使用自己的自定义布局。为此，请`appender.rolling.layout.type`使用其他布局替换该行 。请参阅以下示例：

```properties
appender.rolling.type = RollingFile
appender.rolling.name = rolling
appender.rolling.fileName = ${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs.cluster_name}_server.log
appender.rolling.layout.type = PatternLayout
appender.rolling.layout.pattern = [%d{ISO8601}][%-5p][%-25c{1.}] [%node_name]%marker %.-10000m%n
appender.rolling.filePattern = ${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs.cluster_name}-%d{yyyy-MM-dd}-%i.log.gz
```