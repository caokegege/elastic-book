## 设置堆大小

默认情况下，Elasticsearch告诉JVM使用最小和最大大小为1 GB的堆。在进入生产阶段时，配置堆大小以确保Elasticsearch有足够的可用堆非常重要。

Elasticsearch将通过（最小堆大小）和（最大堆大小）设置分配[jvm.options中](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/jvm-options.html)指定的整个堆 。您应该将这两个设置设置为彼此相等。`Xms` `Xmx`

这些设置的值取决于服务器上可用的RAM数量：

- 设置`Xmx`和`Xms`你的物理内存不超过50％。Elasticsearch出于JVM堆以外的目的需要内存，因此为此留出空间很重要。例如，Elasticsearch使用堆外缓冲区来进行有效的网络通信，依靠操作系统的文件系统缓存来有效地访问文件，并且JVM本身也需要一些内存。观察Elasticsearch过程使用的内存多于该`Xmx`设置配置的限制，这是正常的。

- 组`Xmx`和`Xms`不超过所述阈值，对压缩对象的指针的JVM用途（压缩糟糕）; 确切的阈值有所不同，但接近32 GB。您可以通过在日志中查找如下一行来验证您是否处于阈值以下：

    ```
    heap size [1.9gb], compressed ordinary obje
    ```

- 理想地设置`Xmx`并`Xms`以不超过该阈值对于基于零的压缩糟糕; 确切的阈值有所不同，但是在大多数系统上26 GB是安全的，但是在某些系统上可以达到30 GB。您可以通过使用JVM选项启动Elasticsearch `-XX:+UnlockDiagnosticVMOptions -XX:+PrintCompressedOopsMode`并查找类似于以下内容的行来验证您是否处于此阈值 以下：

    ```
    heap address: 0x000000011be00000, size: 27648 MB, zero based Compressed Oops
    ```

    显示启用了从零开始的压缩oop。如果未启用从零开始的压缩oop，那么您将看到类似于以下内容的行：

    ```
    heap address: 0x0000000118400000, size: 28672 MB, Compressed Oops with base: 0x00000001183ff000
    ```

Elasticsearch可用的堆越多，它可用于其内部缓存的内存就越多，但可供操作系统用于文件系统缓存的内存就越少。同样，较大的堆可能导致较长的垃圾回收暂停。

这是如何通过`jvm.options.d/`文件设置堆大小的示例：

```txt
- Xms2g 
- Xmx2g 
```

也可以通过环境变量设置堆大小。可以通过以下方法设置这些值`ES_JAVA_OPTS`：

```sh
ES_JAVA_OPTS="-Xms2g -Xmx2g" ./bin/elasticsearch 
ES_JAVA_OPTS="-Xms4000m -Xmx4000m" ./bin/elasticsearch 
```

[Windows服务](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/zip-windows.html#windows-service)的堆配置与上述不同。可以为Windows服务初始填充的值可以如上所述配置，但在安装服务后会有所不同。有关其他详细信息，请查阅[Windows服务文档](https://www.elastic.co/guide/en/elasticsearch/reference/7.x/zip-windows.html#windows-service)。